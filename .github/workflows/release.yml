name: Publish release

on:
  release:
    types: [published]

jobs:
  publish-release:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:4.2.0
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v2

      - name: MongoDB-native build with Gradle
        run: ./gradlew clean :mongodb-native:build

      - name: MongoDB-ballerina Build
        uses: ballerina-platform/ballerina-action/@swan-lake-release
        with:
          args:
            build -a -c --sourceroot mongodb-ballerina
        env:
          JAVA_OPTS: -DBALLERINA_DEV_COMPILE_BALLERINA_ORG=true
          MONGODB_HOST: mongodb

      - name: Ballerina Push
        uses: ballerina-platform/ballerina-action/@swan-lake-release
        with:
          args:
            push -a
        env:
          WORKING_DIR: ./mongodb
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_ACCESS_TOKEN }}
